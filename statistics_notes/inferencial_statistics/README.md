# 統計的推定

## 目次

- [統計的推定](#統計的推定)
  - [目次](#目次)
  - [点推定](#点推定)
    - [推定の基礎](#推定の基礎)
      - [- 最尤法](#--最尤法)
      - [- モーメント法](#--モーメント法)
    - [推定量の性質](#推定量の性質)
      - [- 不偏推定量](#--不偏推定量)
      - [- 有効推定量](#--有効推定量)
      - [- 十分推定量](#--十分推定量)
    - [漸近的性質](#漸近的性質)
    - [リサンプリング法](#リサンプリング法)
      - [- ジャックナイフ法](#--ジャックナイフ法)
  - [区間推定](#区間推定)
    - [信頼区間](#信頼区間)
      - [- 平均の区間推定](#--平均の区間推定)
      - [- 分散の区間推定](#--分散の区間推定)
      - [- 分散の比の区間推定](#--分散の比の区間推定)
      - [- 多項分布の信頼区間](#--多項分布の信頼区間)
    - [差の信頼区間](#差の信頼区間)
  - [検定](#検定)
    - [統計的仮説検定の基礎](#統計的仮説検定の基礎)
      - [-  $P$ 値](#---p-値)
      - [- サンプルサイズ設計](#--サンプルサイズ設計)
    - [抜取検査](#抜取検査)
    - [1標本の平均に関する検定](#1標本の平均に関する検定)
      - [- 分散が既知の場合](#--分散が既知の場合)
      - [- 分散が未知の場合](#--分散が未知の場合)
    - [2標本の平均に関する検定](#2標本の平均に関する検定)
      - [- 分散が既知の場合](#--分散が既知の場合-1)
      - [- 分散が未知かつ等分散の場合](#--分散が未知かつ等分散の場合)
      - [- 分散が未知かつ非等分散の場合](#--分散が未知かつ非等分散の場合)
    - [母比率の検定](#母比率の検定)
      - [- 母比率の検定](#--母比率の検定)
      - [- 母比率の差の検定](#--母比率の差の検定)
  - [ノンパラメトリック法](#ノンパラメトリック法)
    - [対応のない2群の検定](#対応のない2群の検定)
      - [- ウィルコクソンの順位和検定](#--ウィルコクソンの順位和検定)
      - [- 並べ替え検定](#--並べ替え検定)
    - [対応のある2群の検定（符号付き検定）](#対応のある2群の検定符号付き検定)
      - [- ウィルコクソンの符号付き順位検定](#--ウィルコクソンの符号付き順位検定)
      - [- 符号検定](#--符号検定)
    - [3群以上の検定](#3群以上の検定)
      - [- クラスカル・ウォリス検定](#--クラスカルウォリス検定)
    - [順位相関係数](#順位相関係数)
      - [- スピアマンの順位相関係数](#--スピアマンの順位相関係数)
      - [- ケンドールの順位相関係数](#--ケンドールの順位相関係数)

## 点推定

### 推定の基礎

パラメータ $\theta$ を持つ確率分布 $F_\theta$ から得られる標本 $\{X_i\}^n_{i=1}$ について考える。<br>

標本の観測値から未知のパラメータ $\theta$ を推測することを**統計的推定**という。<br>

特に、標本から $\hat{\theta}=h(X_1,\dots,X_n)$ のように $\theta$ を推定することを**点推定**という。<br>

この $\hat{\theta}$ のような関数を**推定量**、実際に観測値 $\{x_i\}^n_{i=0}$ を代入したものを**推定値**とよぶ。<br>

推定量のように、未知のパラメータによらない関数を**統計量**という。<br>

<br>

#### - 最尤法

確率分布 $F_\theta$ の確率密度関数を $f(x;\theta)$ としたとき、独立同一分布に従う標本の同時確率密度関数は

$$
L(\theta)=\prod^n_{i=1}f(x_i;\theta)
$$

となる。これを $\theta$ の関数としたとき $L(\theta)$ を尤度関数と呼ぶ。<br>

また、尤度関数の対数をとった対数尤度関数

$$
\log{L(\theta)}=\sum^n_{i=1}\log{f(x_i;\theta)}
$$

を用いることも多い。<br>

<br>

尤度関数は、母数空間 $\Theta$ におけるパラメータ $\theta$ の尤もらしさを表し、その値を尤度とよぶ。<br>

最尤法においては、尤度関数を母数空間 $\Theta$ 内で最大にするパラメータを推定量とする。<br>

このときの推定量を最尤推定量という関数で表し、求めたいパラメータの偏微分

$$
\frac{\partial L(\theta)}{\partial\theta}=0
$$

の解から最尤推定量を求められる。<br>

<details>
<summary>最尤法やスコア関数について</summary>

[パラメータ推定](http://www2.econ.osaka-u.ac.jp/~tanizaki/class/2018/basic_econome/04.pdf)

[わかりやすいフィッシャー情報量](https://yosshiblog.jp/フィッシャー情報量/)

</details>

<br>

#### - モーメント法

最尤法における計算が困難な場合、より簡便な方法としてモーメント法が用いられる。<br>

$m$ 個のパラメータ $\theta=(\theta_1,\dots,\theta_m)$ を持つ確率分布$f(x_i;\theta)$ を考える。各次数の中心モーメント

$$
\mu_k=\int^\infty_{-\infty}(x_i-\mu_1)^kf(x_i;\theta)dx\ ,\quad k=2,3,\cdots
$$

の右辺は $\theta$ の関数であり、これを $m_k(\theta)$ と書くと $\mu_k=m_k(\theta)$ のように表される。<br>

これらを $\theta$ の連立方程式に見立て、十分大きな次数 $K$ までのモーメントを用いると適当な関数 $g_j$ を用いて

$$
\theta_j=g_j(\mu_1,\dots,\mu_k)\ ,\quad j=1,\dots,m
$$

のようにして解ける。その際、各モーメントを標本平均 $\hat{\mu_k}$ や標本分散などの推定量 $\hat{\mu_k}$ で置き換えた $\hat{\theta_j}$ を推定量とする。<br>

<br>

### 推定量の性質

#### - 不偏推定量

$E[\hat\theta]=\theta$ となるような推定量 $\hat\theta$ を不偏推定量とよぶ。<br>

$b_\theta(\hat\theta)\ \coloneqq E_\theta[\hat\theta]-\theta$ を推定量のバイアスとよび、不偏推定量はバイアスが $0$ となるような推定量である。<br>

<br>

平均二乗誤差 $E_\theta[(\hat\theta-\theta)^2]$ は一般に $E[X^2]=E[X]^2+V[X]$ が成り立つことから、以下のバイアス・バリアンス分解が可能である。

$$
E_\theta[(\hat\theta-\theta)^2]=(E_\theta[\hat\theta]-\theta)^2+V_\theta[\hat\theta]=(b_\theta(\hat\theta))^2+V_\theta[\hat\theta]
$$

バイアス項が $0$ かつ分散を最小化する推定量を一様最小分散不偏推定量という。<br>

線型単回帰モデル $y_i=\beta x_i+\varepsilon_i$ に関して、最小二乗法により得られるパラメータ値 $\hat\beta$ は、$\displaystyle\hat\beta=(\sum^n_{j=1}x_j^2)^{-1}\sum^n_{i=1}x_iy_i$ と求まる。<br>

このように $y_i$ の線形和で表されるような回帰パラメータ推定量を線型推定量という。<br>

$\varepsilon_i$ が各 $i$ について $E[\varepsilon_i]=0,\ V[\varepsilon_i]<\infty$ を満たし、さらに $i\neq j$ のとき $E[\varepsilon_i\varepsilon_j]=0$ を満たすと仮定すると、$\hat\beta$ は線型推定量であり、さらに不偏推定量のうち分散が最小になる。（ガウス・マルコフの定理）<br>

<br>これを最良線型不偏推定量（BLUE）とよぶ。

<br>

#### - 有効推定量

以下に述べるクラメール・ラオの不等式により、一般に一様最小分散不偏推定量の判定が可能である。<br>

<br>

フィッシャー情報量は、$f$ を確率密度関数として

$$
J_n(\theta)=E_\theta\left[\left(\frac{\partial}{\partial\theta}\log f(X_1,\dots,X_n;\theta)\right)^2\right]
$$

もしくは適当な正則条件のもとで

$$
J_n(\theta)=E_\theta\left[\left(\frac{\partial^2}{\partial\theta^2}\log f(X_1,\dots,X_n;\theta)\right)\right]
$$

により定義される。フィッシャー情報量が正のとき、クラーメル・ラオの不等式は以下で表される：

$$
V_\theta[\hat\theta]\geq J_n(\theta)^{-1}
$$

標本が独立同一であるとき、 $J_n(\theta)=nJ_1(\theta)$ となり下限値が標本サイズに反比例する。<br>

<br>

クラーメル・ラオの不等式の等号を満たすような不偏推定量を、有効推定量と呼ぶ。よって、有効推定量 $\implies$ 一様最小分散不偏推定量となる。

<br>

#### - 十分推定量

最尤法における必要な標本の情報は、十分推定量によって知ることができる。<br>

パラメータ $\theta$ を持つ分布からの標本をまとめて $X$ と書くとき、以下の式を満たす統計量 $T=T(X)$ を $\theta$ の十分統計量とよぶ。

$$
P(X=x|T(X)=t,\theta)=P(X=x|T(X)=t)
$$

つまり、 $T(X)$ による $X$ の条件付き分布がパラメータによらないことを示している。<br>

$T(X)$ が十分統計量であるときに限り、適当な関数 $h,g$ が存在して

$$
f(x;\theta)=h(x)g(T(x),\theta)
$$

という分解が可能である。（フィッシャー・ネイマンの分解定理）<br>

<br>

### 漸近的性質

標本サイズが十分大きい時の推定の妥当性を評価するための理論を漸近論という。<br>

真のパラメータ値 $\theta$ は未知であるが、どのような値であってもその値に確率収束する時、つまり $\varepsilon>0$ に対し

$$
\lim_{n\rightarrow\infty}P(|\hat\theta-\theta|<\varepsilon)=1
$$

が成立するとき、その推定量は一致性を持つ。<br>

多次元のパラメータの場合も、 $L_2$ノルム $\|\bm{\hat\theta}-\bm{\theta}\|$ を用いて同様に定義される。<br>

<br>

一致推定量の分散が漸近的にクラーメル・ラオの不等式の下限を達成するとき、すなわち任意の $\theta$ に対して

$$
\lim_{n\rightarrow\infty}nV_\theta[\hat\theta]=J_1(\theta)^{-1}
$$

となるとき、推定量が漸近有効性を持つという。<br>

適当な正則条件が成り立つような確率分布に対しては、最尤推定量は一致性および漸近有効性をもつ。<br>

つまり、漸近的に最良な推定量の1つであるといえる。<br>

<br>

さらに、最尤推定量 $\hat\theta$ から $\theta$ を引いたうえで $\sqrt{n}$ でスケーリングした $Z\coloneqq\sqrt{n}(\hat\theta-\theta)$ は $\mathcal{N}(0,J_1(\theta)^{-1})$ に分布収束する。<br>

これを、最尤推定量の漸近正規性という。<br>

<br>

### リサンプリング法

#### - ジャックナイフ法

推定量にバイアスがある場合、得られた標本を再利用して補正する方法。<br>

<br>

標本 $X_1,\dots,X_n$ からの推定量 $\hat\theta$ のバイアスを補正する方法を考える。<br>

標本 $X_i$ を除いた $n-1$ の部分標本から計算される推定量を $\hat\theta_{(-i)}$ と表す。このようにして得られた $n$ 個の推定量の平均を $\displaystyle\hat\theta_{(\cdot)}=\frac1n\sum^n_{i=1}\hat\theta_{(-i)}$ と書く。<br>

このとき、 $\hat\theta$ のバイアスは $\widehat{bias}\coloneqq (n-1)(\hat\theta_{(\cdot)}-\hat\theta)$ で見積もられ、それを補正した

$$
\hat\theta_{jack}\coloneqq\hat\theta-\widehat{bias}=\hat\theta-(n-1)(\hat\theta_{(\cdot)}-\hat\theta)=n\hat\theta-(n-1)\hat\theta_{(\cdot)}
$$

をジャックナイフ推定量という。<br>

<br>

ここで、推定量がバイアスを用いて $E[\hat\theta]=\theta+b(\theta)/n$ のように計算できるとすると、$E[\hat\theta_{(\cdot)}]=\theta+b(\theta)/(n-1)$ となり $E[\, \widehat{bias}\,]=(n-1)(E[\hat\theta_{(\cdot)}]-E[\hat\theta])=b(\theta)/n$ が成り立つことから $\widehat{bias}$ が $b(\theta)/n$ の不偏推定量であることが確認できる。<br>

<br>

## 区間推定

### 信頼区間

#### - 平均の区間推定

$\mathcal{N}(\mu,\sigma^2)$ に従う確率変数について、$\sigma^2$ が既知の場合の母平均の信頼区間を考える。<br>

<br>

この母集団分布からの標本平均 $\bar X$ は $\mathcal{N}(\mu,\sigma^2/n)$ に従うことから、 $\displaystyle z=\frac{\bar{X}-\mu}{\sqrt{\sigma^2/n}}$ は標準正規分布に従う。<br>

ここから、上側および下側 2.5% 点を用いて、以下の確率式が成り立つ。

$$
P(-1.96\leq z\leq 1.96)=0.95
$$

上式に $\displaystyle z=\frac{\bar{X}-\mu}{\sqrt{\sigma^2/n}}$ を代入して $\mu$ について整理すると、以下の式が得られる。

$$
P(\bar{X}-1.96\sqrt{\sigma^2/n}\leq \mu\leq \bar{X}+1.96\sqrt{\sigma^2/n})=0.95
$$

<br>

#### - 分散の区間推定

同様に、$\mathcal{N}(\mu,\sigma^2)$ に従う確率変数について、母分散の信頼区間を考える。( $\mu$ は未知とする)<br>

<br>

この母集団分布からの不偏分散を $\displaystyle S=\frac1{n-1}\sum^n_{i=1}(X_i-\bar{X})^2$ とすると、$\chi^2=(n-1)S/\sigma^2$ は $\chi^2(n-1)$ に従う。<br>

これを用いて母平均と同様、$\sigma^2$ の95%信頼区間は以下の式で表される。

$$
P\left(\frac{(n-1)S}{\chi^2_{0.025}(n-1)}\leq\sigma^2\leq\frac{(n-1)S}{\chi^2_{0.975}(n-1)}\right)=0.95
$$

<br>

#### - 分散の比の区間推定

2つの独立した集団が、それぞれ $\mathcal{N}(\mu_1,\sigma_1^2)$ と $\mathcal{N}(\mu_2,\sigma^2_2)$ に互いに独立に従うとき、統計量 $\displaystyle F=\frac{S_1/\sigma_1^2}{S_2/\sigma_2^2}$ は$F(n_1-1,n_2-1)$ に従う。<br>

これを用いて、母分散の比 $\sigma^2_1/\sigma^2_2$ の95%信頼区間は以下の式で表される。

$$
P\left(\frac{S_1}{S_2}\cdot\frac1{F_{0.025}(\phi_1,\phi_2)}\leq\frac{\sigma^2_1}{\sigma^2_2}\leq\frac{S_1}{S_2}\cdot\frac1{F_{0.975}(\phi_1,\phi_2)}\right)=0.95
$$

<br>

#### - 多項分布の信頼区間

$p_i$ でそれぞれの事象が $N_i$ 回起こるような試行を$n$ 回行う$(i=1,2,\dots,k)$。<br>

このとき、$N_i$ は多項分布に従う。同時確率関数は

$$
P(N_1=n_1,\cdots,N_k=n_k)=\frac{n!}{n_1!n_2!\cdots n_k!}p_1^{n_1}p_2^{n_2}\dots p_k^{n_k}
$$

となる。このとき、 $E[N_i]=np_i,\quad V[N_i]=np_i(1-p_i)$ である。<br>

ここで、$\hat{p_i}=N_i/n$ とし、 $\displaystyle z_i=\frac{\hat{p_i}-p_i}{\sqrt{p_i(1-p_i)/n}}$ とすると、$p_i$ の95%信頼区間は

$$
\begin{gather*}P\left(\hat{p_i}-1.96\sqrt{\frac{\hat{p_i}(1-\hat{p_i})}n}\leq p_i
\leq\hat{p_i}+1.96\sqrt{\frac{\hat{p_i}(1-\hat{p_i})}n}\right)=0.95
\end{gather*}
$$

<br>

### 差の信頼区間

$N_1,N_2$ の共分散は

$$
\begin{align*}
\rm{Cov}[N_1,N_2]
&=E[N_1N_2]-E[N_1]E[N_2] \\
&=n(n-1)p_1p_2-n^2p_1p_2=-np_1p_2
\end{align*}
$$

となる。

$p_1-p_2$ の信頼区間を求めるため、期待値と分散を考える。<br>

$\hat{p_1}-\hat{p_2}$ の期待値は

$$
\begin{equation*}
E[\hat{p_1}-\hat{p_2}]=\frac{np_1}n-\frac{np_2}n=p_1-p_2
\end{equation*}
$$

分散は

$$
\begin{align*}
V[\hat{p_1}-\hat{p_2}]
&=\frac{np_1(1-p_1)}{n^2}+\frac{np_2(1-p_2)}{n^2}-\frac{-2np_1p_2}{n^2} \\
&=\frac{p_1(1-p_1)}{n}+\frac{p_2(1-p_2)}{n}+\frac{2p_1p_2}{n}
\end{align*}
$$

$\displaystyle{z=\frac{(\hat{p_1}-\hat{p_2})-(p_1-p_2)}{\sqrt{\frac{p_1(1-p_1)}{n}+\frac{p_2(1-p_2)}{n}+\frac{2p_1p_2}{n}}}}$ とすると、$z$ は漸近的に標準正規分布に従い、 $p_1-p_2$ の95%信頼区間は

$$
\begin{equation*}\left((\hat{p_1}-\hat{p_2})-1.96\sqrt{\frac{p_1(1-p_1)}{n}+\frac{p_2(1-p_2)}{n}+\frac{2p_1p_2}{n}}\ ,(\hat{p_1}-\hat{p_2})+1.96\sqrt{\frac{p_1(1-p_1)}{n}+\frac{p_2(1-p_2)}{n}+\frac{2p_1p_2}{n}}\right)
\end{equation*}
$$

となる。<br>

<br>

## 検定

### 統計的仮説検定の基礎

確率変数が従う母集団分布のパラメータを推定したとき、それを検証する仮説検定を考える。<br>

このとき、帰無仮説 $H_0$ に基づく統計量を**検定統計量**とよぶ。<br>

<br>

帰無仮説 $H_0$ が正しいという仮定のもとで検定統計量がとる値が稀なものであると判断する確率を**有意水準 $\alpha$**と呼ぶ。<br>

検定統計量が棄却されるぎりぎりの値を棄却限界域（臨界値）という。逆に、受容される領域を受容域という。<br>

<br>

#### -  $P$ 値

帰無仮説 $H_0$ の下で、現在観察されたデータの値と同じか、それより稀にしか起こらないデータが観察される確率。<br>

つまり、帰無分布における検定統計量より上側の確率。<br>

<br>

#### - サンプルサイズ設計

仮説検定では、$H_0$ が真に正しいとしても有意となることがある。これを第一種の過誤という。これは有意水準と等しい。<br>

一方で、対立仮説 $H_1$ が正しいとしても有意と判定されないことがある。これを第二種の過誤と呼び、その確率を $\beta$ で表す。<br>

仮説検定では、有意水準をできるだけ小さく保ち、検出力 $1-\beta$ を大きくすることが望まれる。<br>

<br>

帰無仮説 $H_0$ の下での検定統計量 $Z_0$ の分布は標準正規分布である。<br>

一方、対立仮説 $H_1$ において母平均が $\mu_1$ とすると、検定統計量の期待値は $\displaystyle Z_0=\frac{\mu_1-\mu_0}{\sqrt{\sigma/n}}$ であり、$Z_0$ の分布は $\displaystyle\small\mathcal{N}\left(\frac{\mu_1-\mu_0}{\sqrt{\sigma^2/n}},1\right)$ と表される。<br>

帰無仮説 $H_0$ と対立仮説 $H_1$ の下での2つの検定統計量の分布は重なっており、棄却限界値を境にして $\alpha,\beta$ はそれぞれの分布の裾の面積として定義できる。<br>

したがって、これらはトレードオフの関係にある。<br>

2つの分布の距離は、$H_1$ の下での検定統計量の分布において、平均の差が大きいほど、またサンプルサイズが大きいほど離れる。<br>

<br>

これを利用して、一定の検出力を確保するためのサンプルサイズを求めることが可能である。<br>

対立仮説における検定統計量 $z_0$ の期待値は帰無仮説における棄却限界値 $z_{\alpha/2}$ と対立仮説における$\beta$ に対応する分位点 $z_\beta$

の和に対応するので、サンプルサイズを求める等式は次のようになる。

$$
z_{\alpha/2}+z_\beta=\frac{\mu_1-\mu_0}{\sqrt{\sigma^2/n}}
$$

$n$ について解くと、

$$
\begin{equation*}
n=\frac{(z_{\alpha/2}+z_\beta)^2}{\large\left(\frac{\mu_1-\mu_0}{\sigma}\right)^2}=\frac{(z_{\alpha/2}+z_\beta)^2}{\Delta^2}
\end{equation*}
$$

$\Delta$ は平均値の差と標準偏差の比であり、エフェクトサイズと呼ばれる。これは、効果の大きさが標準偏差の何倍に相当するかを表している。<br>

<br>

### 抜取検査

抜き取り検査とは日本産業規格（JIS）において、<br>

> 「検査ロットから、あらかじめ定められた抜取検査方式に従って、サンプルを抜き取って試験し、その結果をロットの判定基準と比較して、そのロットの合格・不合格を判定する検査」

と定義されている。具体的な手順は以下の通り。<br>

1. 検査ロットを明示し、検査ロットを構成する製品の数 $N$ を特定する。この $N$ をロットの大きさという。
2. 検査ロットより抽出する標本の大きさ $n$ を定める。
3. 検査ロットの合格・不合格の判定基準を定める。<br>

合格の検査ロットの不良率を $p_0$ , 不合格の検査ロットの不良率を $p_1$ とし、サイズ $n$ の標本中の不良個数 $k$ が

$$
\begin{align*}
&k\leq c\ \text{\small{のとき}}&& \text{\small{検査ロット合格}} \\
&k\geq{c+1}\ \text{\small{のとき}}&&\text{\small{検査ロット不合格}}
\end{align*}
$$

と判定されたとき、この $c$ を合格判定個数とよぶ。<br>

このとき不良個数は二項分布にしたがい、合格であるはずのロットが不合格と判定される確率 $FP$ は

$$
FP=\sum^n_{k=c+1}\binom{n}{k}p_0^k(1-p_o)^{n-k}
$$

となり、本来は不合格であるはずのロットが合格と判定される確率 $FN$ は

$$
FN=\sum^c_{k=1}\binom{n}{k}p_1^k(1-p_1)^{n-k}
$$

$FP$ は生産者危険、 $FN$ は消費者危険と呼ばれる。<br>

<br>

### 1標本の平均に関する検定

#### - 分散が既知の場合

確率変数が $\mathcal{N}(\mu,\sigma^2)$ に従うと仮定したときの、両側検定を考える。（片側検定も同様）

帰無仮説は $H_0\colon \mu=\mu_0$ となる。帰無仮説の下での検定統計量 $\displaystyle Z=\frac{\bar{X}-\mu_0}{\sqrt{\sigma^2/n}}$ は標準正規分布に従う。

対立仮説を $H_1\colon \mu\neq\mu_0$ としたとき、棄却する条件は $|Z|\geq z_{\alpha/2}$ <br>

<br>

#### - 分散が未知の場合

分散 $\sigma^2$ が未知なので、標本不偏分散 $s^2$ により推定した値 $\hat\sigma^2$ をを用いる。<br>

ここで、<br>

- $\displaystyle\frac{(n-1)s^2}{\sigma^2}$ は自由度 $n-1$ のカイ二乗分布にしたがう。<br>

- 検定統計量 $T=\displaystyle \frac{\bar{X}-\mu_0}{\sqrt{s^2/n}}$ は $t(n-1)$ にしたがう。

ゆえに、各対立仮説について棄却条件が $t_{\alpha/2}(n-1)$ より定まる。<br>

<br>

### 2標本の平均に関する検定

#### - 分散が既知の場合

各群の確率変数を $X_{A_i},X_{B_i}$ とし、互いに独立に正規分布に従うとする。それぞれの母分散は既知とする。<br>

群 $A,B$ の平均の差を $\delta=\mu_A-\mu_B$ とし、帰無仮説 $H_0\colon\delta=\delta_0$ に対する対立仮説を考える。<br>

<br>

両側検定では $H_1\colon\delta\neq\delta_0$ を対立仮説とする。<br>

各群の標本平均を $\bar{X}_A,\bar{X}_B$ とすると、互いに独立なので $\bar{X}_A-\bar{X}_B$ は 

$$
\displaystyle\mathcal{N}\left(\delta_0,\,\left(\frac{\sigma^2_A}{n_A}+\frac{\sigma^2_B}{n_B}\right)\right)
$$ 

に従う。<br>

<br>

ここで、各群の分散が異なる場合、平均の差を検定する意味があるのかという問題が生じる。（ベーレンス・フィッシャー問題）<br>

これより、 $H_0$ の下での検定統計量

$$
Z=\frac{\bar{X}_A-\bar{X}_B-\delta_0}{\sqrt{\sigma^2\left(\frac1{n_A}+\frac1{n_B}\right)}}
$$

は標準正規分布に従う。<br>

<br>

#### - 分散が未知かつ等分散の場合

分散 $\sigma^2_A,\sigma^2_B$ は未知とする。各群の標本不偏分散 $s^2_A,s^2_B$ で母分散を推定する。<br>

等分散性が明らかである場合、共通の母分散 $\sigma^2$  を仮定すると、プールした標本不偏分散

$$
s^2=\frac{(n_A-1)s^2_A+(n_B-1)s^2_B}{n_A+n_B-2}
$$

で母分散 $\sigma^2$を推定することができる。<br>

ここで、 $\displaystyle\frac{(n_A+n_B-2)s^2}{\sigma^2}$ は 自由度 $n_A+n_B-2$ のカイ2乗分布 に従う。<br>

ゆえに帰無仮説の下で、検定統計量

$$
T=\frac{\bar{X}_A-\bar{X}_B-\delta_0}{\sqrt{s^2\left(\frac1{n_A}+\frac1{n_B}\right)}}
$$

は  $t(n_A+n_B-2)$ に従う。<br>

<br>

#### - 分散が未知かつ非等分散の場合

両母集団の分散が等しくないとき、各群の標本不偏分散を用いて

$$
T=\frac{\bar{X}_A-\bar{X}_B-\delta_0}{\sqrt{\left(\frac{s^2_A}{n_A}+\frac{s^2_B}{n_B}\right)}}
$$

は近似的に自由度が

$$
\nu=\frac{\small(s^2_A/n_A+s^2_B/n_B)^2}{\frac{(s^2_A/n_A)^2}{n_A-1}+\frac{(s^2_A/n_B)^2}{n_B-1}}
$$

に最も近い整数 $\nu^\ast$ の $t$ 分布 $t(\nu^\ast)$ に従う。<br>

これはウェルチの検定と呼ばれる。<br>

<br>

### 母比率の検定

#### - 母比率の検定

二項分布 $Bin(n,\theta)$ に従う確率変数 $X$ を考える。<br>

帰無仮説を $H_0\colon\theta=\theta_0$ とする仮説検定を行うとする。<br>

片側対立仮説 $\theta>\theta_0$ について、棄却域は $\hat\theta-\theta_0\geq c$ とおく。ここで、 $\hat\theta$ は $\theta$ の最尤推定量である。<br>

<br>

したがって、最尤推定量の漸近正規性により $H_0$ の下で $n\rightarrow\infty$ のとき

$$
\frac{\sqrt{n}(\hat\theta-\theta_0)}{\sqrt{\theta_0(1-\theta_0)}}
$$

は標準正規分布に分布収束することを利用すると、近似的に棄却域は

$$
\frac{\sqrt{n}(\hat\theta-\theta_0)}{\sqrt{\theta_0(1-\theta_0)}}\geq z_{\alpha/2}
$$

とすれば求められる。<br>

<br>

#### - 母比率の差の検定

二つの確率変数 $X_A,X_B$ について、帰無仮説 $H_0\colon\theta_A=\theta_B$ の検定を行う。ここで、これらの値は定まっていないことに注意する。<br>

<br>

片側対立仮説 $\theta_A>\theta_B$ について、棄却域を $\hat\theta_A-\hat\theta_B\geq c$ とおく。ここで、 $\hat\theta_A,\hat\theta_B$ は最尤推定量である。<br>

同様にして、 $\hat\theta_A-\hat\theta_B$ の平均および分散を用いて、漸近正規性により $H_0$ の下で $n\rightarrow\infty$ のとき

$$
\frac{(\hat\theta_A-\hat\theta_B)-(\theta_A-\theta_B)}{\sqrt{\frac{\theta_A(1-\theta_A)}{n_A}+\frac{\theta_B(1-\theta_B)}{n_B}}}
$$

は標準正規分布に従う。<br>

ここで、 $\theta_A,\theta_B$ を推定量に置き換えると、$H_0$ の下で $\theta_A-\theta_B=0$ が成り立つことから

$$
\frac{\hat\theta_A-\hat\theta_B}{\sqrt{\frac{\hat\theta_A(1-\hat\theta_A)}{n_A}+\frac{\hat\theta_B(1-\hat\theta_B)}{n_B}}}\geq z_{\alpha/2}
$$

が得られる。<br>

<br>

また分母の計算において、帰無仮説における最尤推定量を用いることもできる。<br>

すなわち、$\theta_A=\theta_B=\theta_\ast$ とおくと尤度関数は

$$
\binom{n_1}{x_1}\binom{n_2}{x_2}\theta_\ast^{x_1+x_2}(1-\theta_\ast)^{n_1+n_2-x_1-x_2}
$$

となり、最尤推定量は $\hat\theta_\ast=(x_1+x_2)/(n_1+n_2)$ と表される。この推定量を用いて

$$
\frac{\hat\theta_A-\hat\theta_B}{\sqrt{\theta_\ast(1-\theta_\ast)\left(\frac1{n_A}+\frac1{n_B}\right)}}\geq z_{\alpha/2}
$$

としてもよい。<br>

<br>

## ノンパラメトリック法

### 対応のない2群の検定

#### - ウィルコクソンの順位和検定

2群における試験の成績が次のように得られたとする:

$$
\begin{array}{l|l l l}
\hline
A & 30 & 20 & 52 \\[2pt]
B & 40 & 50 & 35 \\ \hline
\end{array}
$$

いま、帰無仮説を「2群の分布は同じ」、対立仮説を「群Aの分布の形は群Bと同じだが、悪い方にずれている」とした片側検定を考える。<br>

つまり、中央値の差の検定と考えてよい。<br>

<br>

順位和を、2群をあわせて小さい値から順位を与えたときの和 $W_A$ とする。次に、本例での順位と順位和の実測値( $w_A,w_B$ )を示す。<br>

$$
\begin{array}{l|l l l|r}
\hline
A & 2 & 1 & 6 & 9\\[2pt]
B & 4 & 5 & 3 & 12 \\ \hline
\end{array}
$$

帰無仮説が正しいと仮定すると、順位はランダムになる。<br>

よって、群Aの3人に与えられる順位の組合せ ${}_6\rm{C}_3=20$ を利用し、順位和 $W_A$ が $9$ 以下となる確率を求めれば良い。これを片側 $P$ 値とする。

<br>

次に、とりうる $w_A$ の値とその個数を示す。

$$
\begin{array}{l|r r r r r r r r r r|c}
\hline
w_A & 6 & \,7 & \,8 & \,9 & 10 & 11 & 12 & 13 & 14 & 15 & \text{\footnotesize計} \\[2pt]
\text{\footnotesize個数} & 1 & 1 & 2 & 3 & 3 & 3 & 3 & 2 & 1 & 1 & 20 \\ \hline
\end{array}
$$

したがって、$P$ 値は $P(W_A\leq8.5)=7/20$ と求まる。この値を有意水準と比較し、棄却するか否か考察するのが、本手法の手順である。<br>

<br>

標本サイズが多くなると、$P$ 値の計算が煩雑になる。一般に、サンプルサイズが大きくタイが無い場合、<br>

$$
\begin{align*}
&\mu=\frac{m(m+n+1)}2 \\
&\sigma^2=\frac{mn(m+n+1)}{12}
\end{align*}
$$

の正規分布近似を用いる。<br>

タイがある場合、 $i$ 番目の群に含まれるタイデータの数を $t_i$ として以下の正規分布を用いる:

$$
\begin{align*}
&\mu=\frac{m(m+n+1)}2 \\
&\begin{aligned}
 \sigma^2&=\frac{mn(m+n+1)}{12} -\frac{mn\sum_it_i(t_i^2-1)}{12(m+n)(m+n-1)} \\
 &=\frac{mn}{12(m+n)(m+n-1)}\lbrace (m+n)^3-m-n-\sum_i (t_i-1)t_i(t_i+1) \rbrace
 \end{aligned}
\end{align*}
$$

<br>

#### - 並べ替え検定

上記の例を用いる。<br>

帰無仮説・対立仮説は同様であるが、検定統計量に数値の平均 $\bar{X}_A,\bar{X}_B$ を用いる点が異なる。<br>

<br>

群Aの平均は $\bar{x}_A=102/3,\bar{x}_B=125/3$ である。この値に差があるかを考える。<br>

帰無仮説が正しいとすると、すべての値から3つが無作為に選ばれ、その並びの平均は小さい順に<br>

$85/3,90/3,95/3,\dots,142/3$ となる。次に、これらの値と個数を示す。

$$
\begin{array}{l|c c c c c c c c|c}
\hline
\bar{x}_A & 85/3 & \,90/3 & \,95/3 & \,100/3 & 102/3 & 105/3 & \cdots & 142/3 & \text{\footnotesize計} \\[2pt]
\text{\footnotesize個数} & 1 & 1 & 1 & 1 & 1 & 2 & \cdots & 1 & 20 \\ \hline
\end{array}
$$

この表から、群Aの平均が34以下となる確率 $P(\bar{X}_A\leq34)=5/20=1/4$ となり、これが片側 $P$ 値である。<br>

### 対応のある2群の検定（符号付き検定）

#### - ウィルコクソンの符号付き順位検定

7人の学生に対して補習を行った結果、点数の差（補習の後 $-$ 補習の前）は次のようになった。<br>

$D\colon-15,-9,\ 0,\ 6,\ 11,\ 20,\ 25$ <br>

この補習が有用だったかについて考える。<br>

<br>

ウィルコクソンの順位和検定と同様に並べ替えを行うが、その際に符号を考慮する必要がある。<br>

はじめに、絶対値の小さな順に並べる。ただし、0となった値は除く（n=6)。<br>

$D^{\prime}\colon 6,-9,\ 11,-15,\ 20,\ 25$ <br>

この順に符号付きの順位を割り当てる。<br>

$\tilde{D}\colon 1,-2,\ 3,-4,\ 5,\ 6$ <br>

これらのうち、正値の合計 $T_+$ を検定統計量とする。本例では $t_+=15$ である。<br>

1~6までの数字が正か負かで生じるので、組合せは $2^6=64$ 通りある。すべての組合せを考えると、 $0\sim21$ までの値を取りうる。<br>

符号付き順位検定は分布 $D$ の対称性を仮定することが条件であるため、歪みがある場合に利用することは好ましくない。<br>

帰無仮説は「中央値 $=0$ 」であり、今回は対立仮説を「中央値 $>0$」として考える。<br>

<br>

帰無仮説が正のとき、$T_+$ は $10.5$ くらいの値になるはずである。つまりサンプルサイズ $n$ のとき、 $n(n+1)/4$ 程度の値をとる。<br>

いま、 $t_+=15$ だったので、これ以上の値をとる確率を求めると、 $P(T_+\geq15)=14/64\approx0.22$ となる。これが片側 $P$ 値である。<br>

<br>

人数が多いとき計算は煩雑になる。この場合、サンプルサイズ $n$ が大きいとき、

$$
\begin{align*}
\mu&=\frac{n(n+1)}4 \\
\sigma^2&=\frac{n(n+1)(2n+1)}{24}
\end{align*}
$$

の正規分布近似を用いることができる。<br>

<br>

#### - 符号検定

上記の例を用いて説明する。<br>

<br>

帰無仮説・対立仮説は同様であるが、対称性を仮定する必要はない。<br>

0をとらないサンプルサイズ $n$ に対して、差 $d$ が正になった個数 $T_+$ を検定統計量とする。<br>

帰無仮説が正しいとき、 $T_+$ は二項分布 $Bin(n,0.5)$ に従うと考えられる。<br>

今回の例では $n=6$ であり、$T_+\sim Bin(6,0.5)$ とする。符号検定片側 $P$ 値は

$P(T_+\geq4)=({}_6\rm C_4+{}_6\rm C_5+{}_6\rm C_6)\times(0.5)^6 
=22\times(0.5)^6\approx0.34$となる。

<br>

### 3群以上の検定

#### - クラスカル・ウォリス検定

複数の群の分布に差があるか考える。ここでは3群の場合を扱う。<br>

<br>

帰無仮説は「どの群の分布も同じ」、対立仮説は「すべての群の分布が同じではない」<br>

である。<br>

各群をA,B,C とし、次の左のようなデータを考える。右に、順位、順位和、平均を示す。<br>

$\def\arraystretch{1.1}
\begin{array}{c|r r r r} \hline
A & 22 & 30 & 42 \\
B & 36 & 40 & 50 & 53 \\
C & 25 & 32 & 45 & 48 \\ \hline
\end{array}$ 　　　　$\def\arraystretch{1.1}
\begin{array}{c|r r r r|c|c}\hline
A & 1 & 3 & 7 &  & 11 & 11/3 \\
B & 5 & 6 & 10 & 11 & 32 & 32/4 \\
C & 2 & 4 & 8 & 9 & 23 & 23/4 \\ \hline
\end{array}$<br>

各群のサンプルサイズを $n_A,n_B,n_C$ 、その合計 $N=n_A+n_B+n_C$ 、順位の中央値を $\tilde{N}=(N+1)/2$ とする。<br>

各順位和を $R_A,R_B,R_C$ 、および順位の平均を $\bar{R_A},\bar{R_B},\bar{R_C}$ とするとき、タイが無い場合の検定統計量は

$$
\begin{equation*}H=\frac{12}{N(N+1)}\left(n_A(\bar{R}_A-\tilde{N})^2+n_B(\bar{R}_B-\tilde{N})^2+n_C(\bar{R}_C-\tilde{N})^2\right)
\end{equation*}
$$

となる。これは次のように書き直すことができる。<br>

$$
\begin{equation*}H=\frac{12}{N(N+1)}\left(\frac{R_A^2}{n_A}+\frac{R_B^2}{n_B}+\frac{R_C^2}{n_C}\right)-3(N+1)
\end{equation*}
$$

この $P$ 値を求めるには複雑な計算が必要になるので、各群のサンプルサイズが大きい場合には自由度が $(\text{\footnotesize 群の数}-1)$ の $\chi^2$分布近似を利用する。<br>

<br>

### 順位相関係数

#### - スピアマンの順位相関係数

2次元の順位データにおける相関係数を扱う。<br>

スピアマンの順位相関係数 $r_s$ は2次元データ $(x_i,y_i)$ が共に連続変数である場合のピアソンの積率相関係数と同じ計算を行う。

$$
r_s=1-\frac{\displaystyle{6\sum^n_{i=1}}(x_i-y_i)^2}{n(n^2-1)}
$$

タイデータがある場合、以下の式を用いる。

$$
r_s=\frac{T_x+T_y-\displaystyle\sum^n_{i=1}(x_i-y_i)^2}{2\sqrt{T_xT_y}}
$$

ただし、

$$
T_x=\frac{n(n^2-1)-t_x(t_x^2-1)}{12} \\[8pt]
T_y=\frac{n(n^2-1)-t_y(t_y^2-1)}{12}
$$

#### - ケンドールの順位相関係数

$(x_i,y_i)$ と $(x_j,y_j)(i\neq j)$ に対して $(x_i-y_i)(x_j-y_j)$ が正となる組の数を $P$ , 負となる組の数を $N$ とする。<br>

ケンドールの順位相関係数 $r_k$ は次のように定義する。

$$
r_k=\frac{P-N}{n(n-1)/2}
$$

つまり、順位の大きさの順が一致している組と逆である組の数の差をみている。<br>

タイデータがある場合、タイデータの個数を $T_x,T_y$ として以下の式を用いる。

$$
\begin{equation*}
r_k=\frac{P-N}{\sqrt{n(n-1)/2-T_x}\sqrt{n(n-1)/2-T_y}}
\end{equation*}
$$

<br>
